#!/usr/bin/env bash

{{-  if .openclaw.install }}

set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m✅ $*\033[0m"; }

# Remove old OpenClaw installation if it exists
if command -v openclaw &> /dev/null; then
    warn ">>> OpenClaw is already installed. Removing old version..."
    openclaw uninstall --all --yes --non-interactive
    openclaw gateway stop
    openclaw gateway uninstall
    npx -y openclaw uninstall --all --yes --non-interactive
    rm -rf "${OPENCLAW_STATE_DIR:-$HOME/.openclaw}"

    if [ -f "$HOME/.local/bin/openclaw" ]; then
        rm -f "$HOME/.local/bin/openclaw"
    fi

    if command -v npm &> /dev/null; then
        npm uninstall -g openclaw || true
    fi

    if command -v pnpm &> /dev/null; then
        pnpm remove -g openclaw || true
    fi

    if command -v bun &> /dev/null; then
        bun remove -g openclaw || true
    fi

    if [ -f "$HOME/.config/systemd/user/openclaw-gateway.service" ]; then
        if command -v systemctl &> /dev/null; then
            systemctl --user disable --now openclaw-gateway.service || true
            systemctl --user daemon-reload || true
        fi
        rm -f "$HOME/.config/systemd/user/openclaw-gateway.service"
    fi

    success "OpenClaw was uninstalled"
fi

if [ -d "$HOME/openclaw" ]; then
    rm -rf "$HOME/openclaw"
fi

# PATH correto para ambiente não-interativo
export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"

#Install OpenClaw
info ">>> Installing OpenClaw"
curl -fsSL https://openclaw.ai/install.sh | bash -s -- --beta --no-onboard
#openclaw gateway install
#openclaw gateway
#systemctl --user start openclaw-gateway.service

success ">>>>>> OpenClaw Installed Version: $(openclaw --version) <<<<<<"

{{-  end }}

# vim: filetype=bash
