#!/usr/bin/env bash
# vim: filetype=bash

set -euo pipefail
export PATH="$HOME/.local/bin/:$PATH"


# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m✅ $*\033[0m"; }

{{ if eq .chezmoi.osRelease.id "ubuntu" -}}

info "Updating Ubuntu packages"
sudo apt update -y
sudo apt upgrade -y
success "Updated Ubuntu packages"

info "Installing Ubuntu APT packages"

{{ if .packages.linux.ubuntu.apt -}} # if apt packages

#sudo apt install -y {{ range .packages.linux.ubuntu.apt }} {{.}}{{end}}

success "Installed Ubuntu APT packages"

{{ end -}} # if apt packages


{{ if .packages.linux.ubuntu.ppas -}} # if ppas

{{ range .packages.linux.ubuntu.ppas -}} # range ppas

info ">>> Processando PPA: ppa:{{.name}}"

if ! grep -R "ppa.launchpad.net/{{.name}}" /etc/apt/sources.list.d >/dev/null 2>&1; then
    info ">> Adicionando PPA {{.name}}"
    sudo add-apt-repository -y "ppa:{{.name}}"
    #sudo apt update -y
else
    warn ">> PPA já configurado {{.name}}"
fi

sudo apt update -y

{{ range .packages -}}
if ! dpkg -s "{{.}}" >/dev/null 2>&1; then
    info ">> Instalando pacote: {{.}}"
    sudo apt install -y "{{.}}"
else
    success "Pacote já instalado: {{.}}"
fi
{{ end -}}

{{ end -}} # range ppas

success "Installed Ubuntu PPA packages"

{{ end -}} # if ppas



{{ if .packages.linux.ubuntu.sources  -}} # if sources

{{ range .packages.linux.ubuntu.sources -}} 

SOURCE_FILE="/etc/apt/sources.list.d/{{.name}}.sources"

info "Processando source: {{.name}}"

if [ ! -f "{{.keyring_path}}" ]; then
    info "Importando chave GPG"
    curl -fsSL {{.key_url}} | sudo gpg --dearmor --yes -o "{{.keyring_path}}"
else
    warn "Chave GPG já existente"
fi

if [ ! -f "$SOURCE_FILE" ]; then
    echo ">>>>Adicionando repositório APT"
    sudo tee $SOURCE_FILE > /dev/null <<EOF
Types: {{ .types }}
URIs: {{ .uri }}
Suites: {{ .suites }}
Components: {{ .components }}
Architectures: {{ if .architectures }}{{ range .architectures }}{{.}} {{ end }}{{ else }}amd64{{ end }}
Signed-By: {{ .keyring_path }}
EOF

else
warn "Repositório já configurado"
fi

sudo apt update -y

{{ range .packages -}}
if ! dpkg -s "{{.}}" >/dev/null 2>&1; then
    info ">> Instalando pacote: {{.}}"
    sudo apt install -y "{{.}}"
else
    success "Pacote já instalado: {{.}}"
fi
{{ end -}}

{{ end -}}

success "Installed Ubuntu Sources packages"

{{ end -}} # if sources

{{ if .packages.linux.ubuntu.debs  -}} # if debs

# debs
TEMP_DIR="$HOME/.temp-debs"
mkdir -p "$TEMP_DIR"

{{ range .packages.linux.ubuntu.debs -}} 

info "Processing deb package: {{.name}}"

# Verifica se já está instalado
if dpkg -s "{{.name}}" >/dev/null 2>&1; then
    warn "Package already installed: {{.name}}"
    continue
fi

DEB_FILE=""

# Caso via URL
if [ -n "{{.url}}" ]; then
    DEB_FILE="$TEMP_DIR/{{.name}}.deb"

    if [ ! -f "$DEB_FILE" ]; then
        info "Downloading {{.name}}"
        curl -fL -o "$DEB_FILE" "{{.url}}"
    else
        warn "Deb already downloaded: $DEB_FILE"
    fi
fi

info "Installing {{.name}}"
sudo dpkg -i "$DEB_FILE" || {
warn "Fixing dependencies for {{.name}}"
sudo apt-get install -f -y
}

success "Installed {{.name}}"
{{ end -}}

info "Cleaning temporary files"
rm -rf "$TEMP_DIR"

success "All .deb packages processed successfully"

{{ end -}} # if debs


success "Installed Ubuntu packages"

{{ end -}}
