#!/usr/bin/env bash
# vim: filetype=bash

set -euo pipefail
export PATH="$HOME/.local/bin/:$PATH"


# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m✅ $*\033[0m"; }

{{ if eq .chezmoi.osRelease.id "ubuntu" -}}

info "Updating Ubuntu packages"
sudo apt update -y
sudo apt upgrade -y
success "Updated Ubuntu packages"

info "Installing Ubuntu core packages"

sudo apt install -y {{ range .packages.linux.ubuntu.core }} {{.}}{{end}}


{{ range .packages.linux.ubuntu.sources -}} 


SOURCE_FILE="/etc/apt/sources.list.d/{{.name}}.list"

info "Processando source: {{.name}}"

if [ ! -f "{{.keyring_path}}" ]; then
info "Importando chave GPG"
curl -fsSL {{.key_url}} | sudo gpg --dearmor --yes -o "{{.keyring_path}}"
else
warn "Chave GPG já existente"
fi

if [ ! -f "$SOURCE_FILE" ]; then
echo "  Adicionando repositório APT"
echo "{{.repo}}" | sudo tee "$SOURCE_FILE" >/dev/null
else
warn "Repositório já configurado"
fi

sudo apt-get update

{{ range .packages -}}
if ! dpkg -s "{{.}}" >/dev/null 2>&1; then
    info ">> Instalando pacote: {{.}}"
    sudo apt-get install -y "{{.}}"
else
    success "Pacote já instalado: {{.}}"
fi
{{ end -}}

{{ end -}}

{{ range .packages.linux.ubuntu.ppas -}} 

info "Processando PPA: ppa:{{.name}}"

if ! grep -R "ppa.launchpad.net/{{.name}}" /etc/apt/sources.list.d >/dev/null 2>&1; then
    info ">> Adicionando PPA {{.name}}"
    sudo add-apt-repository -y "ppa:{{.name}}"
    sudo apt-get update
else
    warn ">> PPA já configurado {{.name}}"
fi

sudo apt-get update

{{ range .packages -}}
if ! dpkg -s "{{.}}" >/dev/null 2>&1; then
    info ">> Instalando pacote: {{.}}"
    sudo apt-get install -y "{{.}}"
else
    success "Pacote já instalado: {{.}}"
fi
{{ end -}}

{{ end -}}

success "Installed Ubuntu packages"

{{ end -}}
