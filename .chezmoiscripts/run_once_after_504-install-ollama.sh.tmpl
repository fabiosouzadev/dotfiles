#!/usr/bin/env bash
# vim: filetype=bash
{{ if eq .chezmoi.os "linux" -}}
set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32mâœ… $*\033[0m"; }

# ====================================================================
# 1. REMOVER VERSÃƒO ATUAL DO OLLAMA
# ====================================================================
info ">>> ðŸ—‘ï¸  Removendo versÃ£o atual do Ollama...."

if command -v ollama &>/dev/null; then
  if [ -f /etc/systemd/system/ollama.service ]; then
    sudo systemctl stop ollama
    sudo systemctl disable ollama
    sudo rm /etc/systemd/system/ollama.service
  fi 

  if [ -d /usr/share/ollama ]; then
    sudo userdel ollama
    sudo groupdel ollama
    sudo rm -r /usr/share/ollama
  fi

  OLLAMA_BIN=$(which ollama)

  if [[ "$OLLAMA_BIN" == */bin/* ]]; then
    OLLAMA_LIB="${OLLAMA_BIN//\/bin\//\/lib\/}"
    echo ">>> ðŸ“š Caminho da biblioteca calculado: $OLLAMA_LIB"

          if [ -d "$OLLAMA_LIB" ]; then
            echo ">>> ðŸ§¹ Removendo diretÃ³rio de bibliotecas: $OLLAMA_LIB"
            sudo rm -rf "$OLLAMA_LIB"
          else
            echo ">>> â„¹ï¸ DiretÃ³rio de bibliotecas nÃ£o encontrado: $OLLAMA_LIB"
          fi
  fi

  if [ -d "$HOME/.ollama" ]; then
    sudo rm $(which ollama)
    sudo rm -rf ~/.ollama
  fi
fi

{{ if .ollama.compiled }}

# ====================================================================
# 2. INSTALAR DEPENDÃŠNCIAS PARA COMPILAÃ‡ÃƒO
# ====================================================================


# PATH correto para ambiente nÃ£o-interativo
export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"

info ">>> ðŸ“¦ Instalando dependÃªncias de compilaÃ§Ã£o..."

{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}

sudo pacman -Sy --noconfirm base-devel git cmake make gcc clang

{{ end }} # TODO: Mudar para ELSE quando colocar ubuntu


info ">>> ðŸ”§ Compilando Ollama ..."
[ ! -d "$HOME/ollama-source" ] || rm -rf $HOME/ollama-source/
git clone https://github.com/ollama/ollama.git ~/ollama-source
cd ~/ollama-source


{{ if .dell3530.enabled }}
# ====================================================================
# 3. COMPILAR OLLAMA COM PATCHES ESPECÃFICOS PARA ALDER LAKE-U
# ====================================================================
info ">>> ðŸ”§ Compilando Ollama com otimizaÃ§Ãµes para Alder Lake-U (i7-1355U)"

# Compila com flags especÃ­ficas para Tiger Lake
info ">>> âš¡ Compilando com flags Alder Lake-U (i7-1355U)"
export CGO_CFLAGS="-O3 -march=alderlake -mtune=alderlake -mavx2 -mfma -flto -fno-plt -fassociative-math -freciprocal-math -fno-signed-zeros -fno-trapping-math"
export CGO_LDFLAGS="-O3 -march=alderlake -mtune=alderlake -mavx2 -mfma -flto -fno-plt"
# export CGO_CFLAGS="-O3 -march=alderlake -mtune=alderlake -mavx2 -mfma -fno-plt"
# export CGO_LDFLAGS="-O3 -march=alderlake -mtune=alderlake -mavx2 -mfma"
export CPU_FLAGS="-O3 -march=alderlake -mtune=alderlake -pipe -flto -ffast-math -fomit-frame-pointer"
export CC=clang
export CXX=clang++
export CFLAGS="$CPU_FLAGS"
export CXXFLAGS="$CPU_FLAGS"
export LDFLAGS="-Wl,-O1 -Wl,--as-needed -Wl,-z,now -Wl,-z,relro"
export CGO_ENABLED=1
export OLLAMA_THREADS=10
export OLLAMA_PARALLEL=8
{{ end }} # dell3530

{{ if .dell3520.enabled }}
# ====================================================================
# 3. COMPILAR OLLAMA COM PATCHES ESPECÃFICOS PARA TIGER LAKE
# ====================================================================
info ">>> ðŸ”§ Compilando Ollama com otimizaÃ§Ãµes para i5-1135G7..."

# Compila com flags especÃ­ficas para Tiger Lake
info ">>> âš¡ Compilando com flags AVX2 otimizadas..."
export CGO_CFLAGS="-O3 -march=native -mtune=native -mavx2 -mfma -fno-plt"
export CGO_LDFLAGS="-O3 -march=native -mtune=native -mavx2 -mfma"
export CPU_FLAGS="-O3 -march=tigerlake -mtune=tigerlake -pipe -flto -ffast-math -fomit-frame-pointer"
export CC=clang
export CXX=clang++
export CFLAGS="$CPU_FLAGS"
export CXXFLAGS="$CPU_FLAGS"
export LDFLAGS="-Wl,-O1 -Wl,--as-needed -Wl,-z,now -Wl,-z,relro"
export CGO_ENABLED=1
{{ end }} # dell3520


export GOFLAGS="-buildmode=pie -trimpath -ldflags=-s -ldflags=-w"

#CompilaÃ§Ã£o
INSTALL_DIR="/usr/local/bin"
go clean
go mod tidy
go build \
  -tags "avx avx2" \
  -ldflags="-s -w -extldflags '-static' -X main.version=custom-cachyos" \
  -o ollama .

sudo install -Dm755 ollama "$INSTALL_DIR/ollama"


# Instala a versÃ£o compilada
# sudo cp ./bin/ollama /usr/local/bin/
sudo chmod +x /usr/local/bin/ollama

echo "âœ… Ollama compilado com sucesso!"


# ====================================================================
# 4. CONFIGURAR SERVIÃ‡O SYSTEMD OTIMIZADO
# ====================================================================
echo "âš™ï¸  Configurando serviÃ§o systemd ..."

sudo tee /etc/systemd/system/ollama.service > /dev/null <<'EOF'
[Unit]
Description=Ollama Service
After=network-online.target

[Service]
ExecStart=/usr/local/bin/ollama serve
User=ollama
Group=ollama
Restart=always
RestartSec=3
Environment="PATH=$PATH"

[Install]
WantedBy=multi-user.target
EOF



sudo useradd -r -s /bin/false -U -m -d /usr/share/ollama ollama
sudo usermod -a -G ollama $(whoami)
{{ else }} # compiled

info "Instalando Ollama"
curl -fsSL https://ollama.com/install.sh | sh
sudo systemctl daemon-reload
sudo systemctl enable --now ollama
success "Ollama Installed version: $(ollama -v)"

{{ end }} # else compiled

[ -d /etc/systemd/system/ollama.service.d ] || sudo mkdir /etc/systemd/system/ollama.service.d/

sudo tee /etc/systemd/system/ollama.service.d/override.conf > /dev/null <<'EOF'
[Service]
{{ range .ollama.environments -}}
Environment={{.}}
{{ end -}}

# Prioridade de CPU para evitar travamentos
Nice=-5
CPUSchedulingPolicy=rr
CPUSchedulingPriority=1

# Limites de memÃ³ria realistas para 16GB
MemoryHigh=12G
MemoryMax=14G
MemorySwapMax=4G

EOF

sudo systemctl daemon-reload
sudo systemctl enable --now ollama.service
success "âœ¨ Seu setup de IA local estÃ¡ 100% otimizado para alto desempenho!"

sleep 3
{{ end -}} # linux
