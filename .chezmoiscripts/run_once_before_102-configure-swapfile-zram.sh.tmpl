#!/usr/bin/env bash
# vim: filetype=bash

{{ if eq .chezmoi.os "linux" -}}

{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}
set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32mâœ… $*\033[0m"; }


info ">>> ðŸ§  Configurando ZRAM + SWAP (modo EXTREMO)..."

# --- 0 - LIMPA CONFIGURAÃ‡Ã•ES EXISTENTES ---
info ">>> Desativando SWAPs existentes..."
sudo swapoff -a || true

info ">>> Removendo ZRAMs antigos..."
for dev in /dev/zram*; do
    [[ -b "$dev" ]] && sudo zramctl --reset "$dev" || true
done

# --- 1. DependÃªncias ---
if ! command -v zramctl >/dev/null 2>&1; then
    info ">>> Instalando zram-generator..."
    sudo pacman -Sy --needed --noconfirm zram-generator
fi

# --- 2. ZRAM ---
SWAP_PRIORITY=200

info ">>> Gerando /etc/systemd/zram-generator.conf ..."
sudo tee /etc/systemd/zram-generator.conf > /dev/null <<'EOF'
[zram0]
zram-fraction = 0.75
compression-algorithm = zstd
swap-priority = 200
max-zram-pages = 0
EOF

# --- 3. SWAP fÃ­sico ---
SWAP_FILE="/swapfile"
SWAP_SIZE="16G"

if [ ! -f "$SWAP_FILE" ]; then
  info ">>> Criando arquivo de swap de ${SWAP_SIZE} em SSD..."
  if type -P btrfs >/dev/null 2>&1; then 
    sudo btrfs filesystem mkswapfile --size $SWAP_SIZE $SWAP_FILE
  else
    sudo fallocate -l $SWAP_SIZE $SWAP_FILE
  fi
  sudo chmod 600 $SWAP_FILE
  sudo mkswap $SWAP_FILE
else
    warn ">>> Swapfile jÃ¡ existe, pulando criaÃ§Ã£o."
fi

if ! grep -q "$SWAP_FILE" /etc/fstab; then
    info ">>> Adicionando swapfile ao /etc/fstab..."
    echo "$SWAP_FILE none swap defaults,pri=-1 0 0" | sudo tee -a /etc/fstab
fi

# --- 4. Sysctl agressivo ---
#
info ">>> Aplicando parÃ¢metros agressivos de memÃ³ria..."
sudo tee /etc/modprobe.d/zram.conf > /dev/null <<'EOF'
options zram comp_algorithm=zstd
EOF

sudo tee /etc/sysctl.d/99-zram-extreme.conf > /dev/null <<'EOF'
vm.swappiness = 200
vm.vfs_cache_pressure = 60
vm.min_free_kbytes = 131072
vm.overcommit_memory = 1
vm.overcommit_ratio = 100
vm.dirty_expire_centisecs = 2000
vm.compact_memory = 1
kernel.sched_migration_cost_ns=5000000
vm.max_map_count=524288
EOF

sudo sysctl --system >/dev/null
sudo udevadm control --reload-rules && sudo udevadm trigger
sudo modprobe -r zram && sudo modprobe zram num_devices=2

# --- 5 - CONFIGURA UDEV ---
UDEV_RULES_FILE="/usr/lib/udev/rules.d/30-zram.rules"

info ">>> Atualizando regras do udev para ZRAM/ZSWAP..."
NEW_RULE='ACTION=="change", KERNEL=="zram0", ATTR{initstate}=="1", SYSCTL{vm.swappiness}="200", \
    RUN+="/bin/sh -c '\''echo N > /sys/module/zswap/parameters/enabled'\''"'

if [ -f "$UDEV_RULES_FILE" ]; then
    # BACKUP_FILE="${UDEV_RULES_FILE}.bak_$(date +%Y%m%d%H%M%S)"
    BACKUP_FILE="${UDEV_RULES_FILE}.bak"
    sudo cp "$UDEV_RULES_FILE" "$BACKUP_FILE"
    info "Backup criado: $BACKUP_FILE"
fi

echo "$NEW_RULE" | sudo tee "$UDEV_RULES_FILE" > /dev/null

if sudo grep -q 'SYSCTL{vm.swappiness}="200"' "$UDEV_RULES_FILE"; then
    info "Regra UDEV aplicada com sucesso."
else
    error "Falha ao aplicar regra UDEV. Restaurando backup..."
    if [ -f "$BACKUP_FILE" ]; then
        sudo mv "$BACKUP_FILE" "$UDEV_RULES_FILE"
        info "Backup restaurado."
    else
        error "Nenhum backup encontrado! Verifique manualmente."
    fi
    exit 1
fi

sudo udevadm control --reload-rules
sudo udevadm trigger
info "Regras UDEV recarregadas e aplicadas."

# --- 5. Ativar tudo ---
info ">>> Ativando ZRAM e SWAP..."
sudo systemctl restart systemd-zram-setup@zram0.service || true
sudo swapon --show || sudo swapon "$SWAP_FILE"

# --- 9. ConfiguraÃ§Ã£o automÃ¡tica do GRUB (ZRAM duplo + otimizaÃ§Ãµes de desempenho) ---
info ">>> Ajustando GRUB para parÃ¢metros de ZRAM e otimizaÃ§Ã£o de kernel..."

GRUB_FILE="/etc/default/grub"
KERNEL_FLAGS="zram.enabled=1 zswap.compressor=zstd zswap.max_pool_percent=50 zswap.zpool=zsmalloc"
# KERNEL_FLAGS="zram.enabled=1 transparent_hugepage=always hugepagesz=1G default_hugepagesz=1G mitigations=off nohibernate page_alloc.shuffle=1 vmalloc=512M pti=off intel_pstate=active intel_idle.max_cstate=9 processor.max_cstate=9"


# Cria backup se ainda nÃ£o existir
if [ ! -f "${GRUB_FILE}.bak" ]; then
    sudo cp "$GRUB_FILE" "${GRUB_FILE}.bak"
    info ">>> Backup criado em ${GRUB_FILE}.bak"
fi

# Se jÃ¡ contiver os flags, nÃ£o faz nada
if ! grep -q "zswap.enabled=1" "$GRUB_FILE"; then
  info "ðŸ§¬ Atualizando parÃ¢metros do kernel no GRUB..."

  sudo sed -i -E "s|^(GRUB_CMDLINE_LINUX_DEFAULT=['\"])([^'\"]*)(['\"])|\1\2 ${KERNEL_FLAGS}\3|" "$GRUB_FILE"
  sudo grub-mkconfig -o /boot/grub/grub.cfg
else
  info "âš™ï¸  ParÃ¢metros ZSWAP jÃ¡ presentes no GRUB. Nenhuma modificaÃ§Ã£o necessÃ¡ria."
fi

# info "$(swapon --show)"

# --- 6. Status ---
success ">>> âœ… ConfiguraÃ§Ã£o EXTREMA (ZRAM) aplicada com sucesso!"
info "$(free -h)"
info "$(sysctl vm.swappiness)"
info "$(zramctl)"
success " >>> âœ… ZRAM + ZSWAP configurados com sucesso."

{{ end }}
{{ end -}}
