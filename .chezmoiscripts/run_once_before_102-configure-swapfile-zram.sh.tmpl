#!/usr/bin/env bash

{{ if eq .chezmoi.os "linux" -}}

set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m[SUCCESS]\033[0m $*"; }

info ">>> 游 Configurando ZRAM + SWAP (modo EXTREMO)"

# --- 0. Desativar swaps existentes ---
info ">>> Desativando SWAPs existentes..."
sudo swapoff -a || true

# --- 1. Instalar depend칡ncias ---

{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}
info ">>> Instalando zram-generator (Arch)..."
sudo pacman -S --noconfirm --needed zram-generator
{{ end }}

{{ if eq .chezmoi.osRelease.id "ubuntu" }}
info ">>> Instalando zram-tools (Ubuntu)..."
sudo apt update -y
sudo apt install -y zram-tools util-linux
{{ end }}

# --- 2. Limpar ZRAM antigo ---
info ">>> Removendo dispositivos ZRAM antigos..."
for dev in /dev/zram*; do
  [[ -b "$dev" ]] && sudo zramctl --reset "$dev" || true
done

# --- 3. Configurar ZRAM ---

{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}
info ">>> Gerando /etc/systemd/zram-generator.conf (Arch)..."
sudo tee /etc/systemd/zram-generator.conf > /dev/null <<EOF
[zram0]
zram-size = ram
compression-algorithm = zstd
swap-priority = 200
fs-type = swap
EOF
{{ end }}

{{ if eq .chezmoi.osRelease.id "ubuntu" }}
info ">>> Configurando /etc/default/zramswap (Ubuntu)..."
sudo tee /etc/default/zramswap > /dev/null <<EOF
PERCENT=100
PRIORITY=200
COMPRESSOR=zstd
EOF
{{ end }}

# --- 4. Criar SWAP f칤sico de fallback ---
SWAP_FILE="/swapfile"
SWAP_SIZE="4G"
SWAP_PRIORITY=-10

if [ -f "$SWAP_FILE" ]; then
  info ">>> Removendo swapfile existente..."
  sudo swapoff "$SWAP_FILE" || true
  sudo rm -f "$SWAP_FILE"
fi

info ">>> Criando swapfile de ${SWAP_SIZE}..."

if type -P btrfs >/dev/null 2>&1; then
  sudo btrfs filesystem mkswapfile --size "$SWAP_SIZE" "$SWAP_FILE"
else
  sudo fallocate -l "$SWAP_SIZE" "$SWAP_FILE"
fi

sudo chmod 600 "$SWAP_FILE"
sudo mkswap "$SWAP_FILE"
sudo swapon "$SWAP_FILE" -p "$SWAP_PRIORITY"

if ! grep -q "$SWAP_FILE" /etc/fstab; then
  echo "$SWAP_FILE none swap sw,pri=$SWAP_PRIORITY 0 0" | sudo tee -a /etc/fstab >/dev/null
fi

# --- 5. Sysctl agressivo ---
info ">>> Aplicando par칙metros agressivos de mem칩ria..."

SWAPPINESS="80"
CACHE_PRESSURE="50"

sudo tee /etc/sysctl.d/99-zram-extreme.conf > /dev/null <<EOF
vm.swappiness=$SWAPPINESS
vm.vfs_cache_pressure=$CACHE_PRESSURE
vm.dirty_ratio=15
vm.dirty_background_ratio=5
vm.overcommit_memory=1
vm.overcommit_ratio=100
vm.max_map_count=2147483647

kernel.sched_migration_cost_ns=5000000
kernel.sched_autogroup_enabled=0

vm.dirty_writeback_centisecs=500
vm.dirty_expire_centisecs=500
EOF

sudo sysctl --system >/dev/null

# --- 6. Ativar servi칞os ---

{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}
info ">>> Reiniciando systemd-zram-setup..."
sudo systemctl daemon-reexec
sudo systemctl restart systemd-zram-setup@zram0.service || true
{{ end }}

{{ if eq .chezmoi.osRelease.id "ubuntu" }}
info ">>> Reiniciando zramswap..."
sudo systemctl restart zramswap.service || true
{{ end }}

sudo swapon --show || sudo swapon "$SWAP_FILE"

# --- 7. Ajustar GRUB (zswap) ---
info ">>> Ajustando par칙metros de ZSWAP no GRUB..."

GRUB_FILE="/etc/default/grub"
KERNEL_FLAGS="zswap.enabled=1 zswap.compressor=zstd zswap.max_pool_percent=50 zswap.zpool=zsmalloc"

if [ -f "$GRUB_FILE" ];then
  if ! grep -q "zswap.enabled=1" "$GRUB_FILE"; then

    BACKUP_FILE="${GRUB_FILE}.bak_$(date +%Y%m%d%H%M%S)"
    sudo cp "$GRUB_FILE" "$BACKUP_FILE"
    info ">>> Backup do GRUB criado: $BACKUP_FILE"

    sudo sed -i -E "s|^(GRUB_CMDLINE_LINUX_DEFAULT=['\"])([^'\"]*)(['\"])|\1\2 ${KERNEL_FLAGS}\3|" "$GRUB_FILE"

    # Remover poss칤veis conflitos
    sudo sed -i -E 's/(^| )zswap\.enabled=0( |$)//g' "$GRUB_FILE"

    {{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    {{ end }}

    {{ if eq .chezmoi.osRelease.id "ubuntu" }}
    sudo update-grub
    {{ end }}

  else
    info ">>> Par칙metros ZSWAP j치 presentes no GRUB."
  fi
fi
# --- 8. Status final ---
success ">>> Configura칞칚o EXTREMA aplicada com sucesso"

info ">>> SWAP ativo:"
swapon --show

info ">>> Mem칩ria:"
free -h

info ">>> Swappiness:"
sysctl vm.swappiness

info ">>> ZRAM:"
zramctl || true

success ">>> ZRAM + ZSWAP configurados com sucesso. Reinicie o sistema para efeito completo."

{{ end -}}

# vim: filetype=bash
