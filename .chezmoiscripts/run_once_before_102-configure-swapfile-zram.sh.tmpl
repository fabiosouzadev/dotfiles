#!/usr/bin/env bash

{{ if eq .chezmoi.os "linux" -}}

{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}
set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32mâœ… $*\033[0m"; }


info ">>> ðŸ§  Configurando ZRAM + SWAP (modo EXTREMO)....."

# --- 0 - LIMPA CONFIGURAÃ‡Ã•ES EXISTENTES ---
info ">>> Desativando SWAPs existentes......"
sudo swapoff -a || true

info ">>> Removendo ZRAMs antigos....."
for dev in /dev/zram*; do
    [[ -b "$dev" ]] && sudo zramctl --reset "$dev" || true
done

# --- 1. DependÃªncias ---
if ! command -v zramctl >/dev/null 2>&1; then
    info ">>> Instalando zram-generator..."
    sudo pacman -Sy --needed --noconfirm zram-generator
fi

# --- 2. ZRAM ---
info ">>> Gerando /etc/systemd/zram-generator.conf ..."
sudo tee /etc/systemd/zram-generator.conf > /dev/null <<EOF
[zram0]
zram-size = ram * 0.75
compression-algorithm = zstd
swap-priority = 200
fs-type = swap
EOF

# --- 3. SWAP fÃ­sico ---
SWAP_FILE="/swapfile"
SWAP_SIZE="4G"
SWAP_PRIORITY=-10

# Adicionado para forÃ§ar a criaÃ§Ã£o:
if [ -f "$SWAP_FILE" ]; then
  info ">>> Removendo swapfile existente para forÃ§ar recriaÃ§Ã£o..."
  sudo rm -f "$SWAP_FILE"
fi

if [ ! -f "$SWAP_FILE" ]; then
  info ">>> Criando arquivo de swap de ${SWAP_SIZE} em SSD..."
  if type -P btrfs >/dev/null 2>&1; then 
    sudo btrfs filesystem mkswapfile --size $SWAP_SIZE $SWAP_FILE 2>/dev/null
  else
    sudo fallocate -l $SWAP_SIZE $SWAP_FILE 2>/dev/null
  fi
  sudo chmod 600 $SWAP_FILE
  sudo mkswap $SWAP_FILE
  sudo swapon $SWAP_FILE -p $SWAP_PRIORITY
fi

if ! grep -q "$SWAP_FILE" /etc/fstab; then
    info ">>> Adicionando swapfile ao /etc/fstab..."
    echo "$SWAP_FILE none swap sw,pri=$SWAP_PRIORITY 0 0" | sudo tee -a /etc/fstab >/dev/null 2>&1 || true
fi

success ">>> ZRAM configurado: 12g com prioridade 200 + swapfile de fallback com $SWAP_SIZE"

# --- 4. Sysctl agressivo ---
info ">>> Aplicando parÃ¢metros agressivos de memÃ³ria..."
sudo tee /etc/modprobe.d/zram.conf > /dev/null <<EOF
options zram comp_algorithm=zstd
EOF


SWAPPINESS="80"
CACHE_PRESSURE="50"
sudo tee /etc/sysctl.d/99-zram-extreme.conf > /dev/null <<EOF
# OtimizaÃ§Ãµes para LLMs baseadas no hardware
vm.swappiness=$SWAPPINESS
vm.vfs_cache_pressure=$CACHE_PRESSURE
vm.dirty_ratio=15
vm.dirty_background_ratio=5
vm.overcommit_memory=1
vm.overcommit_ratio=100
vm.max_map_count=2147483647

# Afinidade de CPU para processos de IA
kernel.sched_migration_cost_ns=5000000
kernel.sched_autogroup_enabled=0

# Melhora performance de I/O para SSD NVMe
vm.dirty_writeback_centisecs=500
vm.dirty_expire_centisecs=500
EOF
#
sudo sysctl --system >/dev/null
sudo udevadm control --reload-rules && sudo udevadm trigger
sudo modprobe -r zram

# --- 5 - CONFIGURA UDEV ---
UDEV_RULES_FILE="/usr/lib/udev/rules.d/30-zram.rules"

info ">>> Atualizando regras do udev para ZRAM/ZSWAP..."
NEW_RULE='ACTION=="change", KERNEL=="zram0", ATTR{initstate}=="1", SYSCTL{vm.swappiness}="80", \
    RUN+="/bin/sh -c '\''echo N > /sys/module/zswap/parameters/enabled'\''"'

if [ -f "$UDEV_RULES_FILE" ]; then
    BACKUP_FILE="${UDEV_RULES_FILE}.bak_$(date +%Y%m%d%H%M%S)"
    # BACKUP_FILE="${UDEV_RULES_FILE}.bak"
    sudo cp "$UDEV_RULES_FILE" "$BACKUP_FILE"
    info ">>> Backup criado: $BACKUP_FILE"
fi

echo "$NEW_RULE" | sudo tee "$UDEV_RULES_FILE" > /dev/null

if sudo grep -q "SYSCTL{vm.swappiness}=\"$SWAPPINESS\"" "$UDEV_RULES_FILE"; then
    info ">>> Regra UDEV aplicada com sucesso."
else
    error "Falha ao aplicar regra UDEV. Restaurando backup..."
    if [ -f "$BACKUP_FILE" ]; then
        sudo mv "$BACKUP_FILE" "$UDEV_RULES_FILE"
        info "Backup restaurado."
    else
        error "Nenhum backup encontrado! Verifique manualmente."
    fi
    exit 1
fi

sudo udevadm control --reload-rules
sudo udevadm trigger
info ">>> Regras UDEV recarregadas e aplicadas."

# --- 5. Ativar tudo ---
info ">>> Ativando ZRAM e SWAP..."
sudo systemctl restart systemd-zram-setup@zram0.service || true
sudo swapon --show || sudo swapon "$SWAP_FILE"

# --- 9. ConfiguraÃ§Ã£o automÃ¡tica do GRUB (ZRAM duplo + otimizaÃ§Ãµes de desempenho) ---
info ">>> Ajustando GRUB para parÃ¢metros de ZRAM e otimizaÃ§Ã£o de kernel..."

GRUB_FILE="/etc/default/grub"
KERNEL_FLAGS="zswap.enabled=1 zram.enabled=1 zswap.compressor=zstd zswap.max_pool_percent=50 zswap.zpool=zsmalloc"
# KERNEL_FLAGS="zram.enabled=1 transparent_hugepage=always hugepagesz=1G default_hugepagesz=1G mitigations=off nohibernate page_alloc.shuffle=1 vmalloc=512M pti=off intel_pstate=active intel_idle.max_cstate=9 processor.max_cstate=9"



# Se jÃ¡ contiver os flags, nÃ£o faz nada
if ! grep -q "zswap.enabled=1" "$GRUB_FILE"; then

  if [ -f "$GRUB_FILE" ]; then
    BACKUP_FILE="${GRUB_FILE}.bak_$(date +%Y%m%d%H%M%S)"
    # BACKUP_FILE="${UDEV_RULES_FILE}.bak"
    sudo cp "$GRUB_FILE" "$BACKUP_FILE"
    info ">>> Backup criado: $BACKUP_FILE"
  fi

  info "ðŸ§¬ Atualizando parÃ¢metros do kernel no GRUB...."

  sudo sed -i -E "s|^(GRUB_CMDLINE_LINUX_DEFAULT=['\"])([^'\"]*)(['\"])|\1\2 ${KERNEL_FLAGS}\3|" "$GRUB_FILE"

  # Se 'zswap.enabled=0' existir (agora ou antes), remove-o
  sudo sed -i -E \
    -e '/^GRUB_CMDLINE_LINUX_DEFAULT=/ {
      s/(\s|^)zswap\.enabled=0(\s|$)//g; # Remove 'zswap.enabled=0' com espaÃ§os adjacentes ou inÃ­cio/fim da string.
      s/\s+/ /g;                       # Substitui mÃºltiplos espaÃ§os por um Ãºnico espaÃ§o.
      s/GRUB_CMDLINE_LINUX_DEFAULT=" "/GRUB_CMDLINE_LINUX_DEFAULT=""/g; # Lida com o caso em que 'zswap.enabled=0' era a Ãºnica opÃ§Ã£o, deixando um espaÃ§o.
    }' "$GRUB_FILE"
  
  sudo grub-mkconfig -o /boot/grub/grub.cfg

else
  info "âš™ï¸  ParÃ¢metros ZSWAP jÃ¡ presentes no GRUB. Nenhuma modificaÃ§Ã£o necessÃ¡ria."
fi

info "$(swapon --show)"

# --- 6. Status ---
success ">>> ConfiguraÃ§Ã£o EXTREMA (ZRAM) aplicada com sucesso!"
info "$(free -h)"
info "$(sysctl vm.swappiness)"
info "$(zramctl)"
success " >>> ZRAM + ZSWAP configurados com sucesso."

{{ end }}
{{ end -}}

# vim: filetype=bash
