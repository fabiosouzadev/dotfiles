#!/usr/bin/env bash
# vim: filetype=bash

{{ if .kernels.install }}
{{ if eq .chezmoi.osRelease.id "endeavouros" }}

set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m✅ $*\033[0m"; }

info "Swapfile + Zram"
if [ ! -f /swapfile ]; then
    if type -P btrfs >/dev/null 2>&1; then 
	sudo btrfs filesystem mkswapfile --size 2G /swapfile
    else	
    	sudo fallocate -l 2G /swapfile
    fi
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    echo '/swapfile none swap defaults 0 0' | sudo tee -a /etc/fstab
fi

if [ ! -f "/etc/systemd/zram-generator.conf" ]; then
	sudo cp {{ .chezmoi.sourceDir }}/etc/systemd/zram-generator.conf /etc/systemd/zram-generator.conf
fi

if [ ! -f "/etc/sysctl.d/99-swappiness.conf" ]; then
	sudo cp {{ .chezmoi.sourceDir }}/etc/sysctl.d/99-swappiness.conf /etc/sysctl.d/99-swappiness.conf
fi
# Ativar no fstab (chezmoi já garante template, mas força reload)
sudo mount -a

# Instalar zram-generator se faltar
if ! pacman -Qi zram-generator &>/dev/null; then
    sudo pacman -S --noconfirm zram-generator
fi

# Recarregar systemd para aplicar zram
sudo systemctl daemon-reexec

# Ativar sysctl custom
sudo sysctl --system

# Configurar GRUB para zswap
if ! grep -q "zswap.enabled=1" /etc/default/grub; then
    sudo sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="zswap.enabled=1 zswap.compressor=zstd zswap.max_pool_percent=50 zswap.zpool=zsmalloc /' /etc/default/grub
    sudo grub-mkconfig -o /boot/grub/grub.cfg
fi

# info "$(swapon --show)"
# info "$(free -h)"
success "Configured - Swapfile + Zram - working after reboot"

{{ else }}

error "This script is only for Arch based systems. Exiting..."
exit 1

{{ end }}
{{ end }}
