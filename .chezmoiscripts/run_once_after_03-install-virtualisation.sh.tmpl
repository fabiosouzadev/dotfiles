#!/usr/bin/env bash
# vim: filetype=bash


{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) -}}
set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32mâœ… $*\033[0m"; }


info "Installing virtualisation tools"

sudo pacman -Syu --noconfirm --needed {{ range .packages.linux.arch.virtualisation.core }} {{.}}{{end}}
sudo systemctl enable --now libvirtd.service
sudo usermod -a -G libvirt $(whoami)

sudo sed -i -e 's/^#unix_sock_group/unix_sock_group/' -e "s/^#unix_sock_rw_perms/unix_sock_rw_perms/" -e "s/^#unix_sock_rw_perms/unix_sock_rw_perms/"  /etc/libvirt/libvirtd.conf

echo "user = \"$(whoami)\"" | sudo tee -a /etc/libvirt/qemu.conf > /dev/null
echo "group = \"$(whoami)\"" | sudo tee -a /etc/libvirt/qemu.conf > /dev/null

success "Installed virtualization tools\n"


{{ else }}

error "This script is only for Arch based systems. Exiting..."
exit 1

{{ end -}}
