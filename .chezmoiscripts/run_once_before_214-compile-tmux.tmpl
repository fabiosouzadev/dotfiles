#!/usr/bin/env bash

{{ if eq .chezmoi.os "linux" -}}

set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m[SUCCESS]\033[0m $*"; }

# ----------------------------
# Ubuntu
# ----------------------------
{{ if eq .chezmoi.osRelease.id "ubuntu" }}

info ">>> Install dependencies Tmux (Ubuntu)"

sudo apt install -y \
  libevent-dev \
  ncurses-dev \
  build-essential \
  bison \
  pkg-config


{{ end }}

# ----------------------------
# Arch / EndeavourOS / CachyOS
# ----------------------------
{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}

info ">>> Install dependencies Tmux (Arch)"

sudo pacman -Sy --noconfirm \
    base-devel \
    libevent \
    ncurses \
    make \
    bison \
    pkg-config

{{ end }}

# ----------------------------
# Remove previous Tmux installations
# ----------------------------

info ">>> Remove previous Tmux installations"

if [ -d $HOME/.local/share/tmux/ ]; then 
  sudo rm -r $HOME/.local/share/tmux
fi
if [ -f /usr/local/bin/tmux ]; then
  sudo rm /usr/local/bin/tmux 
fi
if [ -d $HOME/.local/src/tmux ]; then 
  sudo rm -r $HOME/.local/src/tmux 
fi
if [ -d $HOME/.local/state/nvim ]; then 
  sudo rm -r $HOME/.local/state/nvim 
fi
if [ -d $HOME/.tmux ]; then
  sudo rm -r $HOME/.tmux
fi

# ----------------------------
# Build neovim
# ----------------------------
info ">>> Build Tmux from source"

git clone https://github.com/tmux/tmux.git $HOME/.local/src/tmux
cd $HOME/.local/src/tmux
git pull
#git checkout 3.3a
sh autogen.sh
if [ `uname` = 'Darwin' ]; then
  ./configure --enable-utf8proc --prefix=$HOME/.local
elif [ `uname` = 'Linux' ]; then 
  #./configure
  # Test config (https://github.com/tmux/tmux/issues/3218)
  ./configure --enable-debug --prefix=$HOME/.local
fi
make 
make install

success ">>> Tmux build process finished successfully"

{{ end -}}

# vim: filetype=bash
