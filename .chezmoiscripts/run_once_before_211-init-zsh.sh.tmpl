#!/usr/bin/env bash

{{ if eq .chezmoi.os "linux" -}}

set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m[SUCCESS]\033[0m $*"; }

ZSH_BIN="$(command -v zsh || true)"

# ----------------------------
# Ubuntu
# ----------------------------
{{ if eq .chezmoi.osRelease.id "ubuntu" }}

info ">>> Atualizando pacotes (apt)"
sudo apt update -y

if ! command -v zsh >/dev/null 2>&1; then
  info ">>> Instalando Zsh (Ubuntu)"
  sudo apt install -y zsh
else
  info ">>> Zsh já instalado"
fi

ZSH_BIN="$(command -v zsh)"

info ">>> Registrando Zsh em /etc/shells"
grep -q "^$ZSH_BIN$" /etc/shells || echo "$ZSH_BIN" | sudo tee -a /etc/shells >/dev/null

if [ "$SHELL" != "$ZSH_BIN" ]; then
  info ">>> Definindo Zsh como shell padrão"
  chsh -s "$ZSH_BIN"
else
  info ">>> Zsh já é o shell padrão"
fi

success ">>> Zsh pronto no Ubuntu"

{{ end }}

# ----------------------------
# Arch / EndeavourOS / CachyOS
# ----------------------------
{{ if (or (eq .chezmoi.osRelease.id "endeavouros") (eq .chezmoi.osRelease.id "cachyos")) }}

if ! command -v zsh >/dev/null 2>&1; then
  info ">>> Instalando Zsh (Arch)"
  sudo pacman -S --noconfirm --needed zsh
else
  info ">>> Zsh já instalado"
fi

ZSH_BIN="$(command -v zsh)"

info ">>> Definindo Zsh como shell padrão"
if [ "$SHELL" != "$ZSH_BIN" ]; then
  chsh -s "$ZSH_BIN"
else
  info ">>> Zsh já é o shell padrão"
fi

success ">>> Zsh pronto no Arch"

{{ end }}

# ----------------------------
# $HOME/.profile config
# ----------------------------

PROFILE_FILE="$HOME/.profile"

info ">>> Forçando Zsh como shell em sessões gráficas (XFCE fix)"

if ! grep -q 'exec /usr/bin/zsh' "$PROFILE_FILE" 2>/dev/null; then
  cat >> "$PROFILE_FILE" <<'EOF'

# Force Zsh in graphical sessions (XFCE fix)
if [ -x /usr/bin/zsh ] && [ "$SHELL" != "/usr/bin/zsh" ]; then
  export SHELL="/usr/bin/zsh"
  exec /usr/bin/zsh -l
fi
EOF
else
  info ">>> Hook de Zsh já presente em ~/.profile"
fi

# ----------------------------
# Xorg keyboard config
# ----------------------------
KEYBOARD_SRC="{{ .chezmoi.sourceDir }}/private_dot_config/xorg.conf.d/20-keyboard.conf"
KEYBOARD_DST="/etc/X11/xorg.conf.d/20-keyboard.conf"

if [ -f "$KEYBOARD_SRC" ]; then
  info ">>> Configurando layout de teclado"
  sudo mkdir -p /etc/X11/xorg.conf.d
  sudo cp -f "$KEYBOARD_SRC" "$KEYBOARD_DST"
else
  warn "Arquivo de teclado não encontrado: $KEYBOARD_SRC"
fi

# ----------------------------
# Starship prompt
# ----------------------------
if ! command -v starship >/dev/null 2>&1; then
  info ">>> Instalando Starship"
  curl -fsSL https://starship.rs/install.sh | sh -s -- -y
else
  info ">>> Starship já instalado"
fi

# ----------------------------
# Estrutura de diretórios
# ----------------------------
PERSONAL_DIR="$HOME/Projects/Personal"
WORK_DIR="$HOME/Projects/Work/Instivo"

info ">>> Criando diretórios de projetos"
mkdir -p "$PERSONAL_DIR"
mkdir -p "$WORK_DIR"

success ">>> Bootstrap Zsh + Starship finalizado com sucesso"

{{ end -}}

# vim: filetype=bash
