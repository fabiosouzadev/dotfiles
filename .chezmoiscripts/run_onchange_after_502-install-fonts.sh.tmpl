#!/usr/bin/env bash

{{ if eq .chezmoi.os "linux" }}

set -euo pipefail

# Pretty print functions
info()    { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()    { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error()   { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
success() { echo -e "\033[1;32m[SUCCESS]\033[0m $*"; }

info "Installing fonts"

TEMP_DIR_FONTS="$HOME/.temp-fonts"
LOCAL_SHARE_FONTS="$HOME/.local/share/fonts"

mkdir -p "$TEMP_DIR_FONTS"
mkdir -p "$LOCAL_SHARE_FONTS"

cd "$TEMP_DIR_FONTS"

{{ range .fonts.linux.nerdfonts }}
info "Installing Nerd Font: {{ . }}"

ARCHIVE="{{ . }}.tar.xz"

if [ ! -f "$ARCHIVE" ]; then
  curl -fL -o "$ARCHIVE" \
    "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/{{ . }}.tar.xz"
else
  warn "Archive already exists: $ARCHIVE"
fi

tar -xf "$ARCHIVE"
{{ end }}

info "Copying local fonts"

# Polybar fonts
if [ -d "$HOME/.config/polybar/fonts" ]; then
  cp -vr "$HOME/.config/polybar/fonts/." "$LOCAL_SHARE_FONTS/"
fi

if [ -d "$HOME/.config/polybar/fonts/panels" ]; then
  cp -vr "$HOME/.config/polybar/fonts/panels/." "$LOCAL_SHARE_FONTS/"
fi

if [ -d "$HOME/.config/polybar/fonts/terminus" ]; then
  cp -vr "$HOME/.config/polybar/fonts/terminus/." "$LOCAL_SHARE_FONTS/"
fi

# Rofi fonts
if [ -d "$HOME/.config/rofi/fonts" ]; then
  find "$HOME/.config/rofi/fonts" -type f -name "*.ttf" -exec cp -v {} "$LOCAL_SHARE_FONTS/" \;
fi

info "Rebuilding font cache"
fc-cache -fv

info "Cleaning up temporary files"
rm -rf "$TEMP_DIR_FONTS"

# Bat theme cache
{{ if eq .chezmoi.osRelease.id "ubuntu" }}
info "Rebuilding bat cache (Ubuntu)"
batcat cache --build
{{ else }}
info "Rebuilding bat cache"
bat cache --build
{{ end }}

success "Font installation completed successfully"

{{ end }}
# vim: filetype=bash
